name: Decide checks 🗳️

concurrency:
  group: ${{ github.workflow }}-${{ github.head_ref || github.run_id }}
  cancel-in-progress: true

on:
  pull_request:
    paths-ignore:
      - "**/*.md"
  workflow_dispatch:
  push:
    branches:
      - master
    paths-ignore:
      - "**/*.md"

jobs:
  test:
    name: Test 🧪
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: decide
    strategy:
      matrix:
        module: 
          - "authentication"
          - "base"
          - "booth"
          - "census"
          - "decide"
          - "gateway"
          - "mixnet"
          - "postproc"
          - "store"
          - "test-scripts"
          - "visualizer"
          - "voting"

    services:
      postgres:
        image: postgres:latest
        env:
          POSTGRES_USER: decide
          POSTGRES_PASSWORD: decide
          POSTGRES_DB: decide
        ports:
          - 5432:5432
        # needed because the postgres container does not provide a healthcheck
        options: --health-cmd pg_isready --health-interval 10s --health-timeout 5s --health-retries 5

    steps:
    - name: Checkout ⬇️
      uses: actions/checkout@v4.1.1
      with:
        show-progress: false
  
    - name: Setup Python 🐍
      uses: actions/setup-python@v5.0.0
      with:
        python-version: '3.x'
        check-latest: true

    - name: Install dependencies 📦
      run: |
        sudo apt update
        sudo apt install libpq-dev chromium-browser chromium-chromedriver
        echo "pynose==1.4.8" >> ../requirements.txt
        echo "selenium" >> ../requirements.txt
        echo "coverage" >> ../requirements.txt
        echo "setuptools" >> ../requirements.txt
        pip install -r ../requirements.txt
        cp local_settings.gactions.py local_settings.py

    - name: Perform migrations 🗃️
      run: |
        python manage.py migrate

    - name: Run unit tests 🔬
      run: |
        python manage.py test ${{ matrix.module }}

